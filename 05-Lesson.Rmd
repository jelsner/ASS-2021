---
title: "Lesson 5"
author: "James B. Elsner"
date: "January 25, 2021"
output:
  html_document: null
editor_options:
  chunk_output_type: console
---

# Making graphs with functions from the {ggplot2} package

The {ggplot2} package is the most frequently used data visualization tool among data scientists. It is used extensively by the New York Times and 538. It's popular because it teaches you how to think about visualizing your data. There are a few principles underlying the syntax.

1. Mapping data to aesthetics
2. Layering
3. Building plots step by step

We make the functions available to our current working directory by typing
```{r}
if(!require(ggplot2)) install.packages(pkgs = "ggplot2", repos = "http://cran.us.r-project.org")

library(ggplot2)
```

First principle: Map data to aesthetics

Consider the following numeric vectors (`foo`, `bar` and `zaz`). Create a data frame `df` using the `data.frame()` function.
```{r}
foo <- c(-122.419416,-121.886329,-71.05888,-74.005941,-118.243685,-117.161084,-0.127758,-77.036871,
         116.407395,-122.332071,-87.629798,-79.383184,-97.743061,121.473701,72.877656,2.352222,
         77.594563,-75.165222,-112.074037,37.6173)
bar <- c(37.77493,37.338208,42.360083,40.712784,34.052234,32.715738,51.507351,38.907192,39.904211,
         47.60621,41.878114,43.653226,30.267153,31.230416,19.075984,48.856614,12.971599,39.952584,33.448377,55.755826)
zaz <- c(6471,4175,3144,2106,1450,1410,842,835,758,727,688,628,626,510,497,449,419,413,325,318)
df <- data.frame(foo, bar, zaz)

head(df)
```

To make a scatter plot using {ggplot2} syntax we use the `ggplot()` function. Note that the package name is {ggplot2} but the function is `ggplot()` (without the 2). 

Inside the `ggplot()` function we specify the data frame with the `data =` argument. We specify what columns from the data frame are to be mapped to 'aesthetics' with the `aes()` function using the `mapping =` argument. Note that the `aes()` function is nested inside the `ggplot()` function. More on this shortly.

For a scatter plot the aesthetics must include the x and y coordinates at a minimum, and for this example they are `foo` and `bar` respectively.

Then to rendered the scatter plot we include the function `geom_point()` as a layer with the `+` symbol. Numeric values specified by the `x =` and `y =` in the `aes()` function are rendered as points in a two-dimensional cartesian plane.
```{r}
ggplot(data = df, 
       mapping = aes(x = foo, y = bar)) +
  geom_point()
```

We map our data values to aesthetic attributes. The _points_ in the scatter plot are geometric objects that get drawn. In {ggplot2} lingo, the points are _geoms_. More specifically, the points are point _geoms_ that are denoted syntactically with the function `geom_point()`.

All geometric objects have aesthetic attributes. Things like:

* x-position
* y-position
* color
* size
* transparency

When we visualize our data using {ggplot2} syntax, we are creating a mapping between variables in our data frame and the aesthetic attributes of geometric objects. When we create the scatter plot we are mapping `foo` to the x-position aesthetic and we're mapping `bar` to the y-position aesthetic. This may seem trivial `foo` is the x-axis and `bar` is on the y-axis. We can do that in Excel.

But here there is a deeper structure. Theoretically, geometric objects (i.e., the things we draw in a plot, like points) don't just have attributes like position. They have a color, size, etc. 

For example here we map a new variable to the size aesthetic.
```{r}
ggplot(data = df, 
       mapping = aes(x = foo, y = bar)) +
  geom_point(aes(size = zaz))
```

We changed a scatter plot to a bubble chart by mapping a new variable to the size aesthetic. Any visualization we see can be deconstructed into _geom_ specifications and mapping from data to the aesthetic attributes of the geometric objects.

Second principle: Build plots in layers

The principle of layering is important. To create great visualizations, we often need to:

* Plot multiple datasets, or
* Plot a dataset with additional contextual information contained in a second dataset, or
* Plot summaries or statistical transformations over the raw data

Let's modify the bubble chart by getting additional data and plotting it as a new layer below the bubbles. First get the data from the {maps} package and store it in a new data frame.
```{r}
if(!require(maps)) install.packages(pkgs = "maps", repos = "http://cran.us.r-project.org")
library(maps)

df2 <- map_data("world") %>%
  glimpse()
```

Plot the new data as a new layer underneath the bubbles.
```{r}
ggplot(data = df, aes(x = foo, y = bar)) +
  geom_polygon(data = df2, aes(x = long, y = lat, group = group)) +
  geom_point(aes(size = zaz), color = "red")
```

This is the bubble chart from earlier in the post with a new layer added. We transformed a bubble chart into a new visualization called a "dot distribution map," which is much more insightful and much more visually interesting.

The bubble chart is a modified scatter plot and the dot distribution map is a modified bubble chart.

We used two of the data visualization principles (mapping & layering) to build this visualization:

* To create the scatter plot, we mapped `foo` to the x-aesthetic and mapped `bar` to the y-aesthetic
* To create the bubble chart, we mapped a `zaz` to the size-aesthetic
* To create the dot distribution map, we added a layer of polygon data under the bubbles.

Third principle: Iteration (step by step)

The third principle is about process. The process begins with mapping and layering but ends with iteration when we add layers that modify scales, legends, colors, etc. The syntax of `ggplot` _layerability_ enables and rewards iteration. 

Let's assign to `p1` the output of our plot.
```{r}
p1 <- ggplot(data = df, 
             mapping = aes(x = foo, y = bar)) +
        geom_polygon(data = df2, 
                     mapping = aes(x = long, y = lat, group = group)) +
        geom_point(aes(size = zaz), color = "red")
```

```{r}
p2 <- p1 + xlab("Longitude") + ylab("Latitude")
p2 <- p2 + scale_size_continuous(name = "Venture Capital Investment\n(USD, Millions)\n")
p2
```

The `facet_wrap()` function is a layer to iterate (repeat) the entire plot conditional on another variable. It is like the `group_by()` function in the data grammar.

Example 1: Tornadoes

We plot the number of tornadoes by year for the state of Kansas. Recall, the data are in the file `Tornadoes.csv`.
```{r}
Torn.df <- read_csv(file = "Tornadoes.csv") %>%
  rename(Year = yr,
         EF = mag)

Torn.df %>%
  filter(st == "KS") %>%
  group_by(Year) %>%
  summarize(nT = n()) %>%
ggplot(mapping = aes(x = Year, y = nT)) +
  geom_line()
```

We create a bar chart indicating the number of tornadoes by EF rating since 2007.
```{r}
Torn.df %>%
  filter(Year >= 2007, EF != -9) %>%
  group_by(EF) %>%
  summarize(Count = n()) %>%
  ggplot(aes(x = factor(EF), y = Count)) +
    geom_bar(stat = "identity")
```

Here the argument `stat = "identity"` indicates the data are already tabulated. That is, by default `geom_bar()` tables the data if it is integer, character, or factor.

Improve the bar chart. Make it presentable for publication.
```{r}
Torn.df %>%
  filter(Year >= 2007, EF != -9) %>%
  group_by(EF) %>%
  summarize(Count = n()) %>%
ggplot(aes(x = factor(EF), y = Count, fill = Count)) +
  geom_bar(stat = "identity") +
  xlab("EF Rating") + 
  ylab("Number of Tornadoes") +
  scale_fill_continuous(low = 'green', high = 'orange') +
  geom_text(aes(label = Count), vjust = -.5, size = 3) +
  theme_minimal() +
  theme(legend.position = 'none') 
```

Plot a series of bar charts showing the frequency of tornadoes by EF rating for each year since 2005.
```{r}
Torn.df %>%
  filter(Year >= 2005, EF != -9) %>%
ggplot(aes(x = factor(EF))) +
  geom_bar() +
  facet_wrap(~ Year)
```

Example 2: Hot days in the city

The data are from the National Climatic Data Center (NCDC). They are [daily data](http://www.ncdc.noaa.gov/cdo-web/datasets) from the National Weather Service Forecast Office in Tallahassee. The observing site is the Tallahassee International Airport (previously the Tallahassee Municipal Airport and Tallahassee Regional Airport). 

Import the data.
```{r}
( TLH.df <- read_csv(file = "http://myweb.fsu.edu/jelsner/temp/data/TLH_DailySummary.csv",
                     na = "-9999") )
```

The warning concerns the column labeled `TOBS`. By default the column type is logical but there are cases when the values are numbers. This can be ignored safely.

The variable of interest is the daily high temperature in the column labeled `TMAX`. The values are in tens of degrees C so the value of 128 is 12.8 C.

Mutate to add new columns giving the temperatures (daily maximum and daily minimum) in degrees F (original measuring unit) and the dates in calendar days. Select only the date and maximum and minimum temperature columns.
```{r}
TLH.df <- TLH.df %>%
  mutate(TmaxF = round(9/5 * TMAX/10 + 32),
         TminF = round(9/5 * TMIN/10 + 32),
         Date = as.Date(as.character(DATE), 
                        format = "%Y%m%d")) %>%
  select(Date, TmaxF, TminF) %>%
glimpse()
```

Note we again use the `as.Date()` function ({base} see `?as.Date`). The format in the data file is a concatenation of a four-digit year, a two-digit month, and a two-digit day. Thus the format argument is `format = "%Y%m%d"`).

Q: Is it getting hotter in Tallahassee? 

Let's compute the annual average high temperature and create a time series graph. 

We use the `year()` function from the {lubridate} package to get a column called `Year`, the `group_by()` function to group by `Year`, and  the `summarize()` function from the {dplyr} package to get the average daily maximum temperature for each year.
```{r}
library(lubridate)

df <- TLH.df %>%
  mutate(Year = year(Date)) %>%
  group_by(Year) %>%
  summarize(AvgT = mean(TmaxF)) %>%
glimpse()
```

We now have a data frame with two columns: `Year` and `AvgT` (annual average daily high temperature in degrees F).

We now use the grammar of graphs to make a plot. We specify the x aesthetic as `Year` and the y aesthetic as the `AvgT`. We include a point layer and a line layer.
```{r}
library(ggplot2)

ggplot(df, aes(x = Year, y = AvgT)) +
  geom_point(size = 3) +
  geom_line() +
  ylab("Average Annual Temperature in Tallahassee, FL (F)")
```

Q: What's wrong? 

Fix and add a trend line layer. Here we go directly to the graph without saving the resulting data frame. That is, we pipe `%>%` the resulting data frame after applying the {dplyr} verbs to the `ggplot()` function. The object in the first argument of the `ggplot()` function is the result (data frame) from the code above.
```{r}
TLH.df %>%
  mutate(Year = year(Date)) %>%
  filter(Year < 2014) %>%
  group_by(Year) %>%
  summarize(AvgT = mean(TmaxF)) %>%
ggplot(aes(x = Year, y = AvgT)) +
  geom_point(size = 3) +
  geom_line() +
  ylab("Average Annual Temperature in Tallahassee, FL (F)") +
  geom_smooth() +
  theme_minimal()
```

Q: Is the frequency of extremely hot days increasing over time? Let's consider a daily high temperature of 100 F and above as extremely hot.

Here we count the number of days at or above 100F using the `summarize()` function together with the `sum()` function on the logical operator `>=`. If a day is missing a high temperature, we remove it with the `na.rm = TRUE` argument in the `sum()` function.
```{r}
TLH.df %>%
  mutate(Year = year(Date)) %>%
  filter(Year < 2014) %>%
  group_by(Year) %>%
  summarize(N100 = sum(TmaxF >= 100, na.rm = TRUE)) %>%
ggplot(aes(x = Year, y = N100, fill = N100)) + 
  geom_bar(stat = 'identity') + 
  scale_fill_continuous(low = 'orange', high = 'red') +
  geom_text(aes(label = N100), vjust = 1.5, size = 3) +
  scale_x_continuous(breaks = seq(1950, 2013, 10)) +
  ylab(expression(paste("Number of days in Tallahassee, FL at or above 100", {}^o, " F"))) +
  theme_minimal() +
  theme(axis.text.x  = element_text(size = 11), legend.position = "none")
```

Histogram of daily high temperature.
```{r}
gTLH <- ggplot(TLH.df, aes(x = TmaxF)) + 
  geom_histogram(binwidth = 1, aes(fill = ..count..)) +
  scale_fill_continuous(low = 'green', high = 'blue') +
  scale_x_continuous(limits = c(30, 120)) +
  scale_y_continuous(limits = c(0, 1000)) +
  ylab("Number of Days") + 
  xlab(expression(paste("Daily High Temperature in Tallahassee, FL (", {}^o, " F)"))) +
  theme_minimal() +
  theme(legend.position = "none")
```

Q: The most common high temperatures are in the low 90s, but there are relatively few 100+ days. Why?

Compare with Las Vegas, Nevada.
```{r}
LVG.df <- read_csv(file = "http://myweb.fsu.edu/jelsner/temp/data/LV_DailySummary.csv",
                     na = "-9999")

LVG.df <- LVG.df %>%
  mutate(TmaxF = round(9/5 * TMAX/10 + 32),
         TminF = round(9/5 * TMIN/10 + 32),
         Date = as.Date(as.character(DATE), 
                        format = "%Y%m%d")) %>%
  select(Date, TmaxF, TminF)

gLVG <- ggplot(LVG.df, aes(x = TmaxF)) + 
  geom_histogram(binwidth = 1, aes(fill = ..count..)) +
  scale_fill_continuous(low = 'green', high = 'blue') +
  scale_x_continuous(limits = c(30, 120)) +
  scale_y_continuous(limits = c(0, 1000)) +
  ylab("Number of Days") + 
  xlab(expression(paste("Daily High Temperature in Las Vegas, NV (", {}^o, " F)"))) +
  theme_minimal() +
  theme(legend.position = "none")

install.packages("patchwork")
library(patchwork)

gTLH / gLVG
```

Bar plot of the number of tornadoes by month and by state. The code uses the {geofacet} package [@Hafen2020].
```{r}
Torn.sf <- read_sf(dsn = "data/1950-2018-torn-initpoint")

library(geofacet)
library(scales)

Torn.sf %>% 
  as.data.frame() %>%
  group_by(mo, st) %>%
  summarise(nT = n()) %>%
  mutate(month = factor(month.name[mo], levels = month.name)) %>%
#  filter(st != "DC") %>%
ggplot(aes(as.factor(mo), nT)) +
  geom_col(fill = "gray70") +
  facet_geo(~ st, grid = "us_state_grid3", scales = "free_y") +
  scale_x_discrete(breaks = 1:12, labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(title = "Relative peakedness of the tornado season in the Plains",
       caption = "SPC data from 1950-2018") +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(strip.text.x = element_text(size = 6),
        axis.text.x = element_text(size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

* https://exts.ggplot2.tidyverse.org/
* Cheat sheets: https://rstudio.com/resources/cheatsheets/
* More examples: https://geocompr.robinlovelace.net/ {spData} package.